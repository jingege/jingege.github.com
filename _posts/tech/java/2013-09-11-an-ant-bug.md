---
layout: post
date: 2013-09-11 17:58:16
title: Ant的一个bug
categories: [programming]
tags:
- java
- ant
published: true
summary: 发现一个ant的bug，准备贡献个patch的时候发现新版已经fix了，囧
---

前几日发现了ant的一个bug。我写的一个打包的ant脚本在我的mac上运行正常，但有同事在windows上则构建失败，我跑到我的windows上测试了下，居然也是失败的，定位了下问题，发现是`<jar jarfile="path/to/a.jar"/>`在windows上并未创建相应的path/to二级目录。这是我从没遇到过的情况，我首先想到的是去linux上试了下，打包正常这说明并非我的系统环境有多特殊，于是作为一个MacOS用户，一个诡异的想法便开始形成：我觉得这可能是ant在windows上的bug。

然后我去apache下载了最新的ant源码，Jar继承了Zip类，扫了一眼相关源码，看到一段：

{% highlight java %}
File parent = zipFile.getParentFile();
if (parent != null && !parent.isDirectory() && !parent.mkdirs()) {
    throw new BuildException("Failed to create missing parent" + " directory for " + zipFile);
}
{% endhighlight %}

我更疑惑了，看起来ant已经考虑到jar所在的目录的创建了啊。

于是我跑到windows里，准备调试一下相关逻辑，在eclipse里配置了调试环境，把我那个ant脚本作为参数，在开始debug前，我先运行了一下，居然成功了。越来越疑惑了。

仔细想了下，我决定把我windows上老的`ANT_HOME`切换到最新版的ant，然后事情开始明朗了，构建成功了。我终于恍然大悟，可能是因为一直忽略了ant的版本差异，导致浪费这么多精力。我用的是1.7.0版的ant构建出错，但查阅的却是1.9.2版的，难道新版已经修复了这个bug？为了证实这个猜测，我去ant的subversion仓库里，拉取了Zip.java近期的log，终于发现了REV:807960的log：

> create parent directory of archive in <zip> and <tar> if needed. PR 45377. Based on patch by Remie Bolte

果不其然啊！可惜失去一个为开源社区贡献代码的机会。
